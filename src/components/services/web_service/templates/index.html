<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Evove Phone</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #000;
            --fg: #fff;
            --dim: #666;
            --green: #0f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg);
            color: var(--fg);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        /* DISPLAY */
        #display-row {
            flex: 0 0 45vh;
            background: #0b120e;
            padding: 1.6rem 1.2rem;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: space-between;
            gap: 16px;
            min-height: 0;
            user-select: text;
            -webkit-user-select: text;
        }

        #phone-display {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
        }

        #display-points {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--fg);
            letter-spacing: 0.1em;
            text-align: center;
            opacity: 0.5;
        }

        #display-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--fg);
            text-align: center;
            letter-spacing: 0.08em;
            min-height: 3rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #display-number.empty {
            color: var(--dim);
            font-size: 1.8rem;
        }

        #display-label {
            font-size: 0.8rem;
            color: var(--dim);
            text-align: right;
            min-height: 1rem;
        }

        #display-messages-panel {
            flex: 0 0 22vh;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 12px;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.35);
            min-height: 0;
            overflow: hidden;
        }

        #display-messages-title {
            font-size: 0.7rem;
            color: var(--dim);
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }

        #display-messages {
            flex: 1;
            font-size: 0.75rem;
            color: var(--fg);
            opacity: 0.85;
            line-height: 1.35;
            white-space: pre-wrap;
            text-align: left;
            overflow-y: auto;
            padding-right: 4px;
            min-height: 0;
        }

        #display-messages::-webkit-scrollbar {
            width: 6px;
        }

        #display-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.18);
            border-radius: 6px;
        }

        /* KEYPAD - botões fixos centralizados */
        #phone-keypad {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            padding: 1rem;
            user-select: none;
            -webkit-user-select: none;
        }

        .keypad-grid {
            display: grid;
            --key-size: min(18vw, 74px);
            --gap-size: min(2.8vw, 11px);
            grid-template-columns: repeat(3, var(--key-size));
            grid-template-rows: repeat(4, var(--key-size));
            gap: var(--gap-size);
        }

        .keypad-qwerty {
            display: none;
            flex-direction: column;
            --q-key-size: min(9.2vw, 40px);
            --q-gap-size: min(2.0vw, 8px);
            gap: var(--q-gap-size);
        }

        .q-row {
            display: flex;
            gap: var(--q-gap-size);
            justify-content: center;
        }

        .key {
            background: transparent;
            border: 1px solid var(--fg);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            -webkit-user-select: none;
            width: var(--key-size);
            height: var(--key-size);
        }

        .key.letter {
            width: var(--q-key-size);
            height: var(--q-key-size);
            border-radius: 12px;
        }

        .key:active {
            transform: scale(0.92);
            background: var(--fg);
        }

        .key:active .key-number,
        .key:active .key-letters,
        .key:active .key-icon {
            color: var(--bg);
        }

        .key-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--fg);
            line-height: 1;
            transition: color 0.15s ease;
        }

        .key-letters {
            font-size: 0.6rem;
            color: var(--dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 2px;
            transition: color 0.15s ease;
        }

        .key-icon {
            font-size: 1.6rem;
            color: var(--fg);
            font-weight: 700;
            transition: color 0.15s ease;
        }

        .key-icon.mode {
            color: var(--green);
        }

        .key.confirm {
            border-color: var(--green);
            color: var(--green);
        }

        .key.confirm .key-number {
            color: var(--green);
        }

        .key.confirm:active {
            background: var(--green);
            border-color: var(--green);
        }

        .key.confirm:active .key-number {
            color: var(--bg);
        }

        .keypad-mode-text .keypad-grid {
            display: none;
        }

        .keypad-mode-text .keypad-qwerty {
            display: flex;
        }

        /* ACTION BAR */
        #action-bar {
            flex: 0 0 auto;
            display: flex;
            justify-content: center;
            padding: 1rem 1.5rem;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
            background: var(--bg);
        }

        .action-btn {
            padding: 1rem 3rem;
            border: 2px solid var(--fg);
            border-radius: 2rem;
            background: transparent;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            color: var(--fg);
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .action-btn:active {
            transform: scale(0.95);
            background: var(--fg);
            color: var(--bg);
        }

        /* TOAST */
        #toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: var(--fg);
            color: var(--bg);
            padding: 1rem 2rem;
            border-radius: 1rem;
            font-size: 1rem;
            font-weight: 700;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        #toast.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .key.pressed {
            animation: pulse 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- DISPLAY -->
    <div id="display-row">
        <div id="display-points">0</div>
        <div id="display-messages-panel">
            <div id="display-messages-title">SYSTEM</div>
            <div id="display-messages"></div>
        </div>
        <div id="phone-display">
            <div id="display-number" class="empty">dial</div>
            <div id="display-label">Ready.</div>
        </div>
    </div>

    <!-- KEYPAD -->
    <div id="phone-keypad">
        <div class="keypad-grid">
            <!-- Row 1 -->
            <button class="key" data-num="1">
                <span class="key-number">1</span>
                <span class="key-letters"></span>
            </button>
            <button class="key" data-num="2">
                <span class="key-number">2</span>
                <span class="key-letters">ABC</span>
            </button>
            <button class="key" data-num="3">
                <span class="key-number">3</span>
                <span class="key-letters">DEF</span>
            </button>

            <!-- Row 2 -->
            <button class="key" data-num="4">
                <span class="key-number">4</span>
                <span class="key-letters">GHI</span>
            </button>
            <button class="key" data-num="5">
                <span class="key-number">5</span>
                <span class="key-letters">JKL</span>
            </button>
            <button class="key" data-num="6">
                <span class="key-number">6</span>
                <span class="key-letters">MNO</span>
            </button>

            <!-- Row 3 -->
            <button class="key" data-num="7">
                <span class="key-number">7</span>
                <span class="key-letters">PQRS</span>
            </button>
            <button class="key" data-num="8">
                <span class="key-number">8</span>
                <span class="key-letters">TUV</span>
            </button>
            <button class="key" data-num="9">
                <span class="key-number">9</span>
                <span class="key-letters">WXYZ</span>
            </button>

            <!-- Row 4 - classic layout -->
            <button class="key" data-delete="1">
                <span class="key-number">⌫</span>
                <span class="key-letters"></span>
            </button>
            <button class="key" data-num="0">
                <span class="key-number">0</span>
                <span class="key-letters">+</span>
            </button>
            <button class="key confirm" data-confirm="1">
                <span class="key-number">OK</span>
                <span class="key-letters"></span>
            </button>
        </div>
        <div class="keypad-qwerty" aria-label="QWERTY keyboard">
            <div class="q-row">
                <button class="key letter" data-char="Q"><span class="key-number">Q</span></button>
                <button class="key letter" data-char="W"><span class="key-number">W</span></button>
                <button class="key letter" data-char="E"><span class="key-number">E</span></button>
                <button class="key letter" data-char="R"><span class="key-number">R</span></button>
                <button class="key letter" data-char="T"><span class="key-number">T</span></button>
                <button class="key letter" data-char="Y"><span class="key-number">Y</span></button>
                <button class="key letter" data-char="U"><span class="key-number">U</span></button>
                <button class="key letter" data-char="I"><span class="key-number">I</span></button>
                <button class="key letter" data-char="O"><span class="key-number">O</span></button>
                <button class="key letter" data-char="P"><span class="key-number">P</span></button>
            </div>
            <div class="q-row">
                <button class="key letter" data-char="A"><span class="key-number">A</span></button>
                <button class="key letter" data-char="S"><span class="key-number">S</span></button>
                <button class="key letter" data-char="D"><span class="key-number">D</span></button>
                <button class="key letter" data-char="F"><span class="key-number">F</span></button>
                <button class="key letter" data-char="G"><span class="key-number">G</span></button>
                <button class="key letter" data-char="H"><span class="key-number">H</span></button>
                <button class="key letter" data-char="J"><span class="key-number">J</span></button>
                <button class="key letter" data-char="K"><span class="key-number">K</span></button>
                <button class="key letter" data-char="L"><span class="key-number">L</span></button>
            </div>
            <div class="q-row">
                <button class="key letter" data-char="Z"><span class="key-number">Z</span></button>
                <button class="key letter" data-char="X"><span class="key-number">X</span></button>
                <button class="key letter" data-char="C"><span class="key-number">C</span></button>
                <button class="key letter" data-char="V"><span class="key-number">V</span></button>
                <button class="key letter" data-char="B"><span class="key-number">B</span></button>
                <button class="key letter" data-char="N"><span class="key-number">N</span></button>
                <button class="key letter" data-char="M"><span class="key-number">M</span></button>
                <button class="key confirm" data-confirm="1"><span class="key-number">OK</span></button>
            </div>
        </div>
    </div>



    <!-- TOAST -->
    <div id="toast"></div>

    <script>
        // REFS
        const displayPoints = document.getElementById('display-points');
        const displayNumber = document.getElementById('display-number');
        const displayLabel  = document.getElementById('display-label');
        const displayMessages = document.getElementById('display-messages');
        const toast         = document.getElementById('toast');
        const keys          = document.querySelectorAll('.key');
        const keypad        = document.getElementById('phone-keypad');

        // STATE
        let buffer = '';
        let inputMode = 'dial';
        let pendingPrompt = '';
        let executing = false;
        let pendingType = '';
        const messageHistory = [];

        // HELPERS
        function updateDisplay() {
            const emptyLabel = inputMode === 'text' ? 'type' : 'dial';
            if (buffer) {
                displayNumber.textContent = buffer;
                displayNumber.classList.remove('empty');
            } else {
                displayNumber.textContent = emptyLabel;
                displayNumber.classList.add('empty');
            }
        }

        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        async function fetchPreview(buf) {
            if (inputMode === 'text') {
                if (pendingPrompt) {
                    displayLabel.textContent = `Input: ${pendingPrompt}`;
                }
                return;
            }
            if (!buf) {
                displayLabel.textContent = 'Ready.';
                return;
            }

            try {
                const res = await fetch(`/api/preview?buffer=${encodeURIComponent(buf)}`);
                if (!res.ok) throw new Error('offline');
                const data = await res.json();
                
                let preview = data.preview
                    .replace(/ -> /g, ' › ')
                    .replace(/_/g, '')
                    .trim();
                
                displayLabel.textContent = preview || 'Processing...';

                if (data.complete && !executing && buf === buffer) {
                    executing = true;
                    executeCommand(buf).finally(() => {
                        executing = false;
                    });
                }
            } catch (e) {
                displayLabel.textContent = buf;
            }
        }

        async function updateStatus() {
            try {
                const res = await fetch('/api/status');
                if (!res.ok) return;
                const data = await res.json();

                if (data.user) {
                    const metaScore = data.user.metadata && typeof data.user.metadata.score === 'number'
                        ? data.user.metadata.score
                        : null;
                    const scoreVal = (metaScore !== null)
                        ? metaScore
                        : (typeof data.user.score === 'number' ? data.user.score : null);
                    if (scoreVal !== null) {
                        displayPoints.textContent = Math.round(scoreVal).toString();
                    }
                }

                if (data.pending) {
                    pendingPrompt = data.pending.prompt || 'required';
                    pendingType = data.pending.type || '';
                    if (data.pending.type === 'text') {
                        inputMode = 'text';
                        keypad.classList.add('keypad-mode-text');
                        displayLabel.textContent = `Input: ${pendingPrompt}`;
                    } else {
                        inputMode = 'dial';
                        keypad.classList.remove('keypad-mode-text');
                    }
                    updateDisplay();
                } else {
                    pendingPrompt = '';
                    pendingType = '';
                    if (inputMode !== 'dial') {
                        inputMode = 'dial';
                        keypad.classList.remove('keypad-mode-text');
                        updateDisplay();
                    }
                }

                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(m => {
                        const line = Array.isArray(m) ? m.join(' ') : String(m);
                        if (line.trim().length > 0) {
                            messageHistory.push(line);
                        }
                    });
                    if (messageHistory.length > 300) {
                        messageHistory.splice(0, messageHistory.length - 300);
                    }
                    displayMessages.textContent = messageHistory.join('\n');
                    displayMessages.scrollTop = displayMessages.scrollHeight;
                    showToast(data.messages[data.messages.length - 1]);
                }
            } catch (e) { /* offline */ }
        }

        async function executeCommand(buf) {
            try {
                const res = await fetch('/api/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ buffer: buf })
                });
                
                const data = await res.json();
                
                if (data.completed) {
                    showToast('Command executed');
                    buffer = '';
                    updateDisplay();
                    displayLabel.textContent = 'Ready.';
                    updateStatus();
                }
            } catch (e) {
                showToast('Offline');
            }
        }

        // DTMF TONES
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const dtmfFreqs = {
            '1': [697, 1209], '2': [697, 1336], '3': [697, 1477],
            '4': [770, 1209], '5': [770, 1336], '6': [770, 1477],
            '7': [852, 1209], '8': [852, 1336], '9': [852, 1477],
            '0': [941, 1336], '*': [941, 1209], '#': [941, 1477]
        };
        
        function playDTMF(digit, duration = 100) {
            if (!dtmfFreqs[digit]) return;
            
            const [freq1, freq2] = dtmfFreqs[digit];
            const osc1 = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc1.frequency.value = freq1;
            osc2.frequency.value = freq2;
            osc1.type = 'sine';
            osc2.type = 'sine';
            gain.gain.value = 0.1;
            
            osc1.connect(gain);
            osc2.connect(gain);
            gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.1, now + 0.01);
            gain.gain.linearRampToValueAtTime(0, now + duration / 1000);
            
            osc1.start(now);
            osc2.start(now);
            osc1.stop(now + duration / 1000);
            osc2.stop(now + duration / 1000);
        }

        // KEY PRESS
        keys.forEach(key => {
            key.addEventListener('click', () => {
                const num = key.dataset.num;
                const char = key.dataset.char;
                const confirm = key.dataset.confirm;
                const del = key.dataset.delete;
                if (num) {
                    if (pendingType === 'menu') {
                        playDTMF(num);
                        if (navigator.vibrate) navigator.vibrate(10);
                        key.classList.add('pressed');
                        setTimeout(() => key.classList.remove('pressed'), 300);
                        executeCommand(num);
                        return;
                    }
                    playDTMF(num);
                    buffer += num;
                    updateDisplay();
                    fetchPreview(buffer);
                    
                    if (navigator.vibrate) navigator.vibrate(10);
                    
                    key.classList.add('pressed');
                    setTimeout(() => key.classList.remove('pressed'), 300);
                } else if (char) {
                    buffer += char;
                    updateDisplay();
                    fetchPreview(buffer);

                    if (navigator.vibrate) navigator.vibrate(10);

                    key.classList.add('pressed');
                    setTimeout(() => key.classList.remove('pressed'), 300);
                } else if (del) {
                    if (buffer.length === 0) return;
                    buffer = buffer.slice(0, -1);
                    updateDisplay();
                    fetchPreview(buffer);
                } else if (confirm) {
                    if (!buffer) {
                        showToast('Enter text');
                        return;
                    }
                    executeCommand(buffer);
                }
            });
        });

        // Long press on 0 = delete last char
        let longPressTimer;
        const zeroKey = document.querySelector('[data-num="0"]');
        
        zeroKey.addEventListener('touchstart', (e) => {
            longPressTimer = setTimeout(() => {
                if (buffer.length > 0) {
                    buffer = buffer.slice(0, -1);
                    updateDisplay();
                    fetchPreview(buffer);
                    if (navigator.vibrate) navigator.vibrate([15, 5, 15]);
                }
            }, 500);
        });
        
        zeroKey.addEventListener('touchend', () => {
            clearTimeout(longPressTimer);
        });
        
        // Long press delete key = clear all
        let deleteAllTimer;
        const deleteKey = document.querySelector('[data-delete="1"]');
        if (deleteKey) {
            deleteKey.addEventListener('touchstart', () => {
                deleteAllTimer = setTimeout(() => {
                    if (buffer.length === 0) return;
                    buffer = '';
                    updateDisplay();
                    fetchPreview(buffer);
                    if (navigator.vibrate) navigator.vibrate([15, 5, 15]);
                }, 550);
            });
            deleteKey.addEventListener('touchend', () => {
                clearTimeout(deleteAllTimer);
            });
        }

        // INIT
        async function init() {
            keypad.classList.remove('keypad-mode-text');
            inputMode = 'dial';
            pendingPrompt = '';
            updateDisplay();
            try {
                await fetch('/api/cancel', { method: 'POST' });
            } catch (e) { /* ignore */ }
            updateStatus();
            setInterval(updateStatus, 3000);
        }

        init();
    </script>
</body>
</html>
