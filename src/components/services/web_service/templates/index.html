<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Evove Phone</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #000;
            --fg: #fff;
            --dim: #666;
            --green: #0f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg);
            color: var(--fg);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        /* DISPLAY */
        #display-row {
            flex: 0 0 auto;
            background: var(--bg);
            padding: 2.6rem 1.5rem 0.5rem 1.5rem;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            user-select: text;
            -webkit-user-select: text;
        }

        #phone-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
        }

        #display-points {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--fg);
            letter-spacing: 0.1em;
            text-align: center;
            opacity: 0.5;
        }

        #display-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--fg);
            text-align: center;
            letter-spacing: 0.08em;
            min-height: 3rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #display-number.empty {
            color: var(--dim);
            font-size: 1.8rem;
        }

        #display-label {
            font-size: 0.8rem;
            color: var(--dim);
            text-align: center;
            min-height: 1rem;
        }

        #delete-btn {
            align-self: flex-start;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: var(--fg);
            font-size: 1.0rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.75;
            transition: opacity 0.2s ease, background 0.2s ease, transform 0.15s ease;
        }

        #delete-btn:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.08);
        }

        #delete-btn:active {
            transform: scale(0.96);
        }

        /* KEYPAD - botões fixos centralizados */
        #phone-keypad {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            padding: 2rem;
            user-select: none;
            -webkit-user-select: none;
        }

        .keypad-grid {
            display: grid;
            grid-template-columns: repeat(3, 88px);
            grid-template-rows: repeat(4, 88px);
            gap: 14px;
        }

        .key {
            background: transparent;
            border: 1px solid var(--fg);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            -webkit-user-select: none;
            width: 88px;
            height: 88px;
        }

        .key:active {
            transform: scale(0.92);
            background: var(--fg);
        }

        .key:active .key-number,
        .key:active .key-letters,
        .key:active .key-icon {
            color: var(--bg);
        }

        .key-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--fg);
            line-height: 1;
            transition: color 0.15s ease;
        }

        .key-letters {
            font-size: 0.6rem;
            color: var(--dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 2px;
            transition: color 0.15s ease;
        }

        .key-icon {
            font-size: 1.6rem;
            color: var(--fg);
            font-weight: 700;
            transition: color 0.15s ease;
        }

        .key-icon.mode {
            color: var(--green);
        }

        /* ACTION BAR */
        #action-bar {
            flex: 0 0 auto;
            display: flex;
            justify-content: center;
            padding: 1rem 1.5rem;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
            background: var(--bg);
        }

        .action-btn {
            padding: 1rem 3rem;
            border: 2px solid var(--fg);
            border-radius: 2rem;
            background: transparent;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            color: var(--fg);
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .action-btn:active {
            transform: scale(0.95);
            background: var(--fg);
            color: var(--bg);
        }

        /* TOAST */
        #toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: var(--fg);
            color: var(--bg);
            padding: 1rem 2rem;
            border-radius: 1rem;
            font-size: 1rem;
            font-weight: 700;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        #toast.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .key.pressed {
            animation: pulse 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- DISPLAY -->
    <div id="display-row">
        <div id="phone-display">
            <div id="display-points">0.0</div>
            <div id="display-number" class="empty">dial</div>
            <div id="display-label">Ready.</div>
        </div>
        <button id="delete-btn" aria-label="Delete last character" title="Delete">⌫</button>
    </div>

    <!-- KEYPAD -->
    <div id="phone-keypad">
        <div class="keypad-grid">
            <!-- Row 1 -->
            <button class="key" data-num="1">
                <span class="key-number">1</span>
                <span class="key-letters"></span>
            </button>
            <button class="key" data-num="2">
                <span class="key-number">2</span>
                <span class="key-letters">ABC</span>
            </button>
            <button class="key" data-num="3">
                <span class="key-number">3</span>
                <span class="key-letters">DEF</span>
            </button>

            <!-- Row 2 -->
            <button class="key" data-num="4">
                <span class="key-number">4</span>
                <span class="key-letters">GHI</span>
            </button>
            <button class="key" data-num="5">
                <span class="key-number">5</span>
                <span class="key-letters">JKL</span>
            </button>
            <button class="key" data-num="6">
                <span class="key-number">6</span>
                <span class="key-letters">MNO</span>
            </button>

            <!-- Row 3 -->
            <button class="key" data-num="7">
                <span class="key-number">7</span>
                <span class="key-letters">PQRS</span>
            </button>
            <button class="key" data-num="8">
                <span class="key-number">8</span>
                <span class="key-letters">TUV</span>
            </button>
            <button class="key" data-num="9">
                <span class="key-number">9</span>
                <span class="key-letters">WXYZ</span>
            </button>

            <!-- Row 4 - classic layout -->
            <button class="key" data-num="*">
                <span class="key-number">*</span>
                <span class="key-letters"></span>
            </button>
            <button class="key" data-num="0">
                <span class="key-number">0</span>
                <span class="key-letters">+</span>
            </button>
            <button class="key" data-num="#">
                <span class="key-number">#</span>
                <span class="key-letters"></span>
            </button>
        </div>
    </div>



    <!-- TOAST -->
    <div id="toast"></div>

    <script>
        // REFS
        const displayPoints = document.getElementById('display-points');
        const displayNumber = document.getElementById('display-number');
        const displayLabel  = document.getElementById('display-label');
        const deleteBtn     = document.getElementById('delete-btn');
        const callBtn       = document.getElementById('call-btn');
        const toast         = document.getElementById('toast');
        const keys          = document.querySelectorAll('.key');

        // STATE
        let buffer = '';

        // HELPERS
        function updateDisplay() {
            if (buffer) {
                displayNumber.textContent = buffer;
                displayNumber.classList.remove('empty');
            } else {
                displayNumber.textContent = 'dial';
                displayNumber.classList.add('empty');
            }
        }

        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        async function fetchPreview(buf) {
            if (!buf) {
                displayLabel.textContent = 'Ready.';
                return;
            }

            try {
                const res = await fetch(`/api/preview?buffer=${encodeURIComponent(buf)}`);
                if (!res.ok) throw new Error('offline');
                const data = await res.json();
                
                let preview = data.preview
                    .replace(/ -> /g, ' › ')
                    .replace(/_/g, '')
                    .trim();
                
                displayLabel.textContent = preview || 'Processing...';
            } catch (e) {
                displayLabel.textContent = buf;
            }
        }

        async function updateStatus() {
            try {
                const res = await fetch('/api/status');
                if (!res.ok) return;
                const data = await res.json();

                if (data.user && typeof data.user.total_points === 'number') {
                    displayPoints.textContent = data.user.total_points.toFixed(1);
                }

                if (data.messages && data.messages.length > 0) {
                    showToast(data.messages[data.messages.length - 1]);
                }
            } catch (e) { /* offline */ }
        }

        async function executeCommand(buf) {
            try {
                const res = await fetch('/api/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ buffer: buf })
                });
                
                const data = await res.json();
                
                if (data.completed) {
                    showToast('Command executed');
                    buffer = '';
                    updateDisplay();
                    displayLabel.textContent = 'Ready.';
                    updateStatus();
                }
            } catch (e) {
                showToast('Offline');
            }
        }

        // DTMF TONES
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const dtmfFreqs = {
            '1': [697, 1209], '2': [697, 1336], '3': [697, 1477],
            '4': [770, 1209], '5': [770, 1336], '6': [770, 1477],
            '7': [852, 1209], '8': [852, 1336], '9': [852, 1477],
            '0': [941, 1336], '*': [941, 1209], '#': [941, 1477]
        };
        
        function playDTMF(digit, duration = 100) {
            if (!dtmfFreqs[digit]) return;
            
            const [freq1, freq2] = dtmfFreqs[digit];
            const osc1 = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc1.frequency.value = freq1;
            osc2.frequency.value = freq2;
            osc1.type = 'sine';
            osc2.type = 'sine';
            gain.gain.value = 0.1;
            
            osc1.connect(gain);
            osc2.connect(gain);
            gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.1, now + 0.01);
            gain.gain.linearRampToValueAtTime(0, now + duration / 1000);
            
            osc1.start(now);
            osc2.start(now);
            osc1.stop(now + duration / 1000);
            osc2.stop(now + duration / 1000);
        }

        // KEY PRESS
        keys.forEach(key => {
            key.addEventListener('click', () => {
                const num = key.dataset.num;
                if (num) {
                    playDTMF(num);
                    buffer += num;
                    updateDisplay();
                    fetchPreview(buffer);
                    
                    if (navigator.vibrate) navigator.vibrate(10);
                    
                    key.classList.add('pressed');
                    setTimeout(() => key.classList.remove('pressed'), 300);
                }
            });
        });

        // Long press on 0 = delete last char
        let longPressTimer;
        const zeroKey = document.querySelector('[data-num="0"]');
        
        zeroKey.addEventListener('touchstart', (e) => {
            longPressTimer = setTimeout(() => {
                if (buffer.length > 0) {
                    buffer = buffer.slice(0, -1);
                    updateDisplay();
                    fetchPreview(buffer);
                    if (navigator.vibrate) navigator.vibrate([15, 5, 15]);
                }
            }, 500);
        });
        
        zeroKey.addEventListener('touchend', () => {
            clearTimeout(longPressTimer);
        });

        deleteBtn.addEventListener('click', () => {
            if (buffer.length === 0) return;
            buffer = buffer.slice(0, -1);
            updateDisplay();
            fetchPreview(buffer);
        });

        // CALL (execute)
        callBtn.addEventListener('click', () => {
            if (!buffer) {
                showToast('Enter a number');
                return;
            }
            executeCommand(buffer);
        });

        // INIT
        updateStatus();
        setInterval(updateStatus, 3000);
    </script>
</body>
</html>
